{% extends 'socialapp/base.html' %}

{% block extra_css %}
<style>
    .messages-container {
        height: calc(100vh - 56px);
        display: flex;
    }
    .conversation-list {
        width: 300px;
        border-right: 1px solid #dee2e6;
        overflow-y: auto;
    }
    .chat-window {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
    }
    .message-input {
        border-top: 1px solid #dee2e6;
        padding: 15px;
    }
    .user-search {
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="messages-container">
    <div class="conversation-list">
        <div class="user-search">
            <input type="text" id="user-search" class="form-control" placeholder="Search users...">
        </div>
        <div id="conversation-list">
            {% for user in users %}
                <div class="p-3 border-bottom user-conversation" data-user-id="{{ user.id }}">
                    {% if user.profile_picture %}
                        <img src="{{ user.profile_picture.url }}" alt="{{ user.username }}" class="rounded-circle mr-2" style="width: 40px; height: 40px; object-fit: cover;">
                    {% else %}
                        <img src="https://via.placeholder.com/40" alt="{{ user.username }}" class="rounded-circle mr-2">
                    {% endif %}
                    <span>{{ user.username }}</span>
                </div>
            {% endfor %}
        </div>
    </div>
    <div class="chat-window">
        <div class="chat-messages" id="chat-messages">
            <!-- Messages will be loaded here -->
        </div>
        <div class="message-input">
            <form id="message-form">
                <div class="input-group">
                    <input type="text" id="message-content" class="form-control" placeholder="Type a message...">
                    <div class="input-group-append">
                        <button class="btn btn-primary" type="submit">Send</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentUserId = null;
    const currentUserIdValue = "{{ request.user.id }}";
    const csrfToken = "{{ csrf_token }}";

    function loadMessages(userId) {
        currentUserId = userId;
        fetch('/get-messages/' + userId + '/')
            .then(response => response.json())
            .then(data => {
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.innerHTML = '';
                data.messages.forEach(message => {
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message ' + (message.sender == currentUserIdValue ? 'text-right' : '');
                    messageElement.innerHTML = 
                        '<p><strong>' + (message.sender == currentUserIdValue ? 'You' : 'Other User') + '</strong></p>' +
                        '<p>' + message.content + '</p>' +
                        '<small class="text-muted">' + new Date(message.timestamp).toLocaleString() + '</small>';
                    messagesContainer.appendChild(messageElement);
                });
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
    }

    document.querySelectorAll('.user-conversation').forEach(element => {
        element.addEventListener('click', function() {
            loadMessages(this.dataset.userId);
        });
    });

    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const content = document.getElementById('message-content').value;
        if (content && currentUserId) {
            fetch('/send-message/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: 'receiver_id=' + currentUserId + '&content=' + encodeURIComponent(content)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('message-content').value = '';
                    loadMessages(currentUserId);
                }
            });
        }
    });

    document.getElementById('user-search').addEventListener('input', function() {
        const query = this.value;
        if (query.length > 2) {
            fetch('/search-users/?query=' + encodeURIComponent(query))
                .then(response => response.json())
                .then(data => {
                    const conversationList = document.getElementById('conversation-list');
                    conversationList.innerHTML = '';
                    data.users.forEach(user => {
                        const userElement = document.createElement('div');
                        userElement.className = 'p-3 border-bottom user-conversation';
                        userElement.dataset.userId = user.id;
                        userElement.innerHTML = 
                            '<img src="' + (user.profile_picture || 'https://via.placeholder.com/40') + '" alt="' + user.username + '" class="rounded-circle mr-2" style="width: 40px; height: 40px; object-fit: cover;">' +
                            '<span>' + user.username + '</span>';
                        userElement.addEventListener('click', function() {
                            loadMessages(user.id);
                        });
                        conversationList.appendChild(userElement);
                    });
                });
        }
    });
</script>
{% endblock %}
